<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>结婚适配度测试表</title>
    <!-- 引入Chart.js用于数据可视化 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入html2canvas用于导出结果 -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- 引入jsPDF用于PDF导出 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #ff6b9d;
            --secondary-color: #ffb6c1;
            --accent-color: #ffd700;
            --light-color: #fff5f7;
            --dark-color: #8b3a62;
            --text-color: #333;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: var(--light-color);
            color: var(--text-color);
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .background-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .balloon {
            position: absolute;
            opacity: 0.7;
            animation: float 15s infinite ease-in-out;
        }
        
        .balloon.heart {
            width: 40px;
            height: 40px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .balloon.red { background-color: #ff6b6b; }
        .balloon.pink { background-color: #ff9ff3; }
        .balloon.purple { background-color: #a29bfe; }
        .balloon.blue { background-color: #74b9ff; }
        .balloon.yellow { background-color: #ffeaa7; }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: var(--shadow);
            position: relative;
            z-index: 1;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            cursor: pointer;
            user-select: none;
        }
        
        h2 {
            font-size: 1.5rem;
            margin: 20px 0 15px;
            color: var(--dark-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 5px;
        }
        
        h3 {
            font-size: 1.3rem;
            margin: 15px 0 10px;
            color: var(--dark-color);
        }
        
        h4 {
            font-size: 1.1rem;
            margin: 10px 0;
            color: var(--dark-color);
        }
        
        .intro {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-color);
        }
        
        .dimension {
            margin-bottom: 30px;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .progress-info {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
            font-style: italic;
        }
        
        .question {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            background-color: white;
            position: relative;
        }
        
        .question.unanswered {
            border-left: 4px solid #ff6b6b;
            background-color: #fff5f5;
        }
        
        .unanswered-marker {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #ff6b6b;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }
        
        .options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
        }
        
        .option {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }
        
        .option input {
            margin-right: 5px;
        }
        
        .dimension-score {
            font-weight: bold;
            margin-top: 10px;
            padding: 5px 10px;
            background-color: var(--light-color);
            border-radius: 5px;
            display: inline-block;
        }
        
        .dimension-footer {
            text-align: center;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
            font-style: italic;
            color: #777;
        }
        
        .results-section {
            margin-top: 40px;
            padding: 20px;
            background-color: #f8f8f8;
            border-radius: 10px;
            display: none;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .results-table th, .results-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        
        .results-table th {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .results-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .commentary {
            margin-top: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        
        .submit-btn {
            display: block;
            margin: 30px auto;
            padding: 15px 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        
        .submit-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .loading-btn {
            pointer-events: none;
        }
        
        .loading-btn::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border: 4px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: button-loading-spinner 1s ease infinite;
        }
        
        @keyframes button-loading-spinner {
            from {
                transform: rotate(0turn);
            }
            to {
                transform: rotate(1turn);
            }
        }
        
        .pass {
            color: #28a745;
            font-weight: bold;
        }
        
        .fail {
            color: #dc3545;
            font-weight: bold;
        }
        
        .special-questions {
            margin-top: 30px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 8px;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            color: #777;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
        }
        
        .activation-section {
            max-width: 500px;
            margin: 50px auto;
            padding: 30px;
            background-color: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .activation-input {
            width: 100%;
            padding: 12px;
            margin: 20px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            text-align: center;
        }
        
        .admin-section {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            background-color: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
            text-align: center;
            display: none;
        }
        
        .admin-btn {
            padding: 10px 20px;
            background-color: var(--dark-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        
        .activation-codes {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f8f8;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .dimension-analysis {
            margin-top: 15px;
            padding: 15px;
            background-color: #fff5f5;
            border-radius: 8px;
            border-left: 4px solid #ff6b6b;
        }
        
        .dimension-analysis h4 {
            color: #dc3545;
            margin-bottom: 10px;
        }
        
        .dimension-commentary {
            margin-top: 15px;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 8px;
            border-left: 4px solid #74b9ff;
        }
        
        .dimension-commentary h4 {
            color: #2d7dd2;
            margin-bottom: 10px;
        }
        
        .confirmation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .modal-confirm {
            background-color: var(--primary-color);
            color: white;
        }
        
        .modal-cancel {
            background-color: #ddd;
            color: #333;
        }
        
        .warning-message {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .charts-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 30px 0;
            justify-content: space-around;
        }
        
        .chart-wrapper {
            flex: 1;
            min-width: 300px;
            max-width: 500px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            text-align: center;
            margin-bottom: 15px;
            color: var(--dark-color);
            font-weight: bold;
        }
        
        .export-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .export-btn {
            padding: 10px 20px;
            background-color: var(--dark-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .personalized-advice {
            margin-top: 30px;
            padding: 20px;
            background-color: #fff9e6;
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }
        
        .personalized-advice h4 {
            color: var(--dark-color);
            margin-bottom: 15px;
        }
        
        .personalized-advice ul {
            padding-left: 20px;
        }
        
        .personalized-advice li {
            margin-bottom: 10px;
        }
        
        /* 5级评分样式 */
        .rating-excellent {
            color: #6f42c1; /* 紫色 - 闭眼冲 */
            font-weight: bold;
            background-color: #f8f9ff;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .rating-good {
            color: #28a745; /* 绿色 - 优秀 */
            font-weight: bold;
            background-color: #f8fff9;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .rating-medium {
            color: #007bff; /* 蓝色 - 达标 */
            font-weight: bold;
            background-color: #f0f8ff;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .rating-poor {
            color: #ffc107; /* 黄色 - 待提升 */
            font-weight: bold;
            background-color: #fff9e6;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .rating-critical {
            color: #dc3545; /* 红色 - 慎重 */
            font-weight: bold;
            background-color: #fff5f5;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        /* 激活码使用次数提示 */
        .usage-info {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
        }
        
        /* 评分准则说明 */
        .rating-guide {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }
        
        .rating-guide h4 {
            color: var(--dark-color);
            margin-bottom: 10px;
        }
        
        .rating-guide ul {
            padding-left: 20px;
        }
        
        .rating-guide li {
            margin-bottom: 8px;
        }
        
        /* 管理员入口样式 */
        .admin-trigger {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        /* 隐藏的管理员按钮 */
        .hidden-admin-btn {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            opacity: 0.1;
            z-index: 9999;
        }
        
        .hidden-admin-btn:hover {
            opacity: 0.3;
        }
        
        /* 新增：保存/加载进度按钮 */
        .progress-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .progress-btn {
            padding: 10px 20px;
            background-color: var(--dark-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .progress-btn:hover {
            background-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        /* 新增：问题导航 */
        .question-navigation {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 15px;
            z-index: 100;
            max-height: 70vh;
            overflow-y: auto;
            display: none;
        }
        
        .nav-dimension {
            margin-bottom: 10px;
        }
        
        .nav-dimension-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--dark-color);
            cursor: pointer;
        }
        
        .nav-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-left: 10px;
        }
        
        .nav-question {
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #f0f0f0;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .nav-question.answered {
            background: var(--primary-color);
            color: white;
        }
        
        .nav-question.current {
            border: 2px solid var(--accent-color);
        }
        
        .nav-toggle {
            position: fixed;
            right: 20px;
            top: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
            z-index: 101;
            box-shadow: var(--shadow);
        }
        
        @media (max-width: 768px) {
            .options {
                flex-direction: column;
                gap: 5px;
            }
            
            .option {
                margin-right: 0;
            }
            
            .container {
                padding: 10px;
            }
            
            .modal-buttons {
                flex-direction: column;
            }
            
            .charts-container {
                flex-direction: column;
            }
            
            .chart-wrapper {
                max-width: 100%;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .question-navigation {
                right: 10px;
                left: 10px;
                max-width: calc(100% - 20px);
            }
            
            .progress-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- 隐藏的管理员按钮 -->
    <button class="hidden-admin-btn" id="hiddenAdminBtn" title="管理员入口"></button>
    
    <!-- 问题导航按钮 -->
    <button class="nav-toggle" id="navToggle">问题导航</button>
    
    <!-- 问题导航面板 -->
    <div class="question-navigation" id="questionNavigation">
        <!-- 导航内容将通过JS动态生成 -->
    </div>
    
    <div class="background-elements" id="backgroundElements"></div>
    
    <!-- 激活码验证部分 -->
    <section class="activation-section" id="activationSection">
        <h2 class="admin-trigger" id="adminTrigger">结婚适配度测试表</h2>
        <p>请输入激活码以使用本测试表</p>
        <input type="text" class="activation-input" id="activationInput" placeholder="请输入激活码">
        <div class="usage-info" id="usageInfo">
            <!-- 使用次数信息将在这里显示 -->
        </div>
        <button class="submit-btn" id="activateBtn">激活</button>
        <p style="margin-top: 20px; font-size: 0.9rem; color: #666;">如需获取激活码，请联系管理员</p>
    </section>
    
    <!-- 管理员界面 -->
    <section class="admin-section" id="adminSection">
        <h2>激活码管理系统</h2>
        <p>当前时间: <span id="currentTime"></span></p>
        <button class="admin-btn" id="generateCodesBtn">生成20个激活码（有效期30天）</button>
        <button class="admin-btn" id="clearStorageBtn">清除所有数据</button>
        <div class="activation-codes" id="activationCodesList">
            <!-- 激活码列表将在这里显示 -->
        </div>
        <button class="admin-btn" id="backToActivationBtn">返回激活页面</button>
    </section>
    
    <!-- 测试表主体内容 -->
    <div class="container" id="testContainer" style="display: none;">
        <header>
            <h1 class="admin-trigger" id="testTitle">男女朋友结婚适配度测试表</h1>
            <p>为恋爱1年以上、有明确结婚规划的情侣设计</p>
        </header>
        
        <section class="intro">
            <p><strong>答题前必读：</strong></p>
            <ul>
                <li>适用人群：恋爱1年以上、有明确结婚规划的情侣</li>
                <li>答题方式：建议双方独立作答后对比分数，或共同协商填写</li>
                <li>计分规则：普通题"是"计5分，"基本是"计4分，"不确定"计3分，"基本否"计2分，"否"计1分；标注"（反）"的题目为反向计分</li>
            </ul>
            <p style="margin-top: 10px;"><strong>温馨提示：</strong>测试表分10个维度，共100道题，可以给家人们一个忠实的参考评价与建议。满分为500分，分值越高，证明你们的适配度越高，测试得分在450分以上，基本可以闭眼冲！！！</p>
            <p style="margin-top: 10px;">由于题目较多，需要20分钟左右作答，在安静环境下完成最佳。</p>
            <p style="margin-top: 10px; font-weight: bold; color: var(--primary-color);">准备好了吗？我们马上开启测试之旅。</p>
        </section>
        
        <!-- 新增：进度管理按钮 -->
        <div class="progress-buttons">
            <button class="progress-btn" id="saveProgressBtn">保存进度</button>
            <button class="progress-btn" id="loadProgressBtn">加载进度</button>
            <button class="progress-btn" id="clearProgressBtn">清除进度</button>
        </div>
        
        <div class="warning-message" id="warningMessage">
            <strong>提示：</strong>您还有 <span id="unansweredCount">0</span> 道题目未完成，请完成所有题目后再提交测试。
        </div>
        
        <form id="compatibilityTest">
            <!-- 各维度题目将在这里动态生成 -->
        </form>
        
        <section class="special-questions">
            <h2>特殊场景补充题（可选作答，不计入总分）</h2>
            <p>以下题目针对特殊情侣场景设计，帮助获取更精准的参考建议</p>
            
            <div class="question">
                <p>1. 异地恋专属：你们对"结束异地的时间、定居城市"有明确规划，且双方都认可吗？</p>
                <div class="options">
                    <div class="option"><input type="radio" name="special1" value="是"> 是</div>
                    <div class="option"><input type="radio" name="special1" value="基本是"> 基本是</div>
                    <div class="option"><input type="radio" name="special1" value="不确定"> 不确定</div>
                    <div class="option"><input type="radio" name="special1" value="基本否"> 基本否</div>
                    <div class="option"><input type="radio" name="special1" value="否"> 否</div>
                </div>
            </div>
            
            <div class="question">
                <p>2. 二婚专属：你们能坦诚沟通过往婚姻经历，且双方子女（若有）能接受彼此的角色吗？</p>
                <div class="options">
                    <div class="option"><input type="radio" name="special2" value="是"> 是</div>
                    <div class="option"><input type="radio" name="special2" value="基本是"> 基本是</div>
                    <div class="option"><input type="radio" name="special2" value="不确定"> 不确定</div>
                    <div class="option"><input type="radio" name="special2" value="基本否"> 基本否</div>
                    <div class="option"><input type="radio" name="special2" value="否"> 否</div>
                </div>
            </div>
            
            <div class="question">
                <p>3. 丁克专属：你们对"不生育子女"的决定完全坚定，不会因长辈压力或后期想法改变而产生分歧吗？</p>
                <div class="options">
                    <div class="option"><input type="radio" name="special3" value="是"> 是</div>
                    <div class="option"><input type="radio" name="special3" value="基本是"> 基本是</div>
                    <div class="option"><input type="radio" name="special3" value="不确定"> 不确定</div>
                    <div class="option"><input type="radio" name="special3" value="基本否"> 基本否</div>
                    <div class="option"><input type="radio" name="special3" value="否"> 否</div>
                </div>
            </div>
        </section>
        
        <button type="button" class="submit-btn" id="calculateResults" disabled>计算测试结果</button>
        
        <section class="results-section" id="resultsSection">
            <h2>测试结果</h2>
            
            <!-- 图表容器 -->
            <div class="charts-container">
                <div class="chart-wrapper">
                    <div class="chart-title">各维度得分雷达图</div>
                    <canvas id="radarChart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-title">各维度得分柱状图</div>
                    <canvas id="barChart"></canvas>
                </div>
            </div>
            
            <div class="results-table-container">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>维度名称</th>
                            <th>题目编号</th>
                            <th>维度得分</th>
                            <th>满分</th>
                            <th>评价等级</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- 结果将在这里动态生成 -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2"><strong>测试总分</strong></td>
                            <td colspan="3" id="totalScoreCell"><strong>0</strong> 分</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <!-- 评分准则说明 -->
            <div class="rating-guide">
                <h4>评分准则说明</h4>
                <ul>
                    <li><span class="rating-excellent">闭眼冲 (90-100%)</span> - 该维度表现极佳，是你们关系的强项</li>
                    <li><span class="rating-good">优秀 (80-89%)</span> - 该维度表现优秀，继续保持</li>
                    <li><span class="rating-medium">达标 (70-79%)</span> - 该维度达到基本要求，有提升空间</li>
                    <li><span class="rating-poor">待提升 (60-69%)</span> - 该维度需要重点关注和改善</li>
                    <li><span class="rating-critical">慎重 (0-59%)</span> - 该维度存在明显问题，需要认真对待</li>
                </ul>
            </div>
            
            <div class="commentary" id="commentary">
                <!-- 评语将在这里动态生成 -->
            </div>
            
            <!-- 个性化建议 -->
            <div class="personalized-advice" id="personalizedAdvice">
                <!-- 个性化建议将在这里动态生成 -->
            </div>
            
            <!-- 导出按钮 -->
            <div class="export-buttons">
                <button class="export-btn" id="exportImage">导出为图片</button>
                <button class="export-btn" id="exportPDF">导出为PDF</button>
            </div>
        </section>
        
        <footer>
            <p><strong>免责提示：</strong>本测试基于婚恋心理学及市场调研数据设计，仅为情侣评估婚姻适配度提供参考，不构成婚姻决策的唯一依据。婚姻质量取决于双方的沟通、包容与共同经营，建议结合实际情况综合考量，必要时可咨询专业婚恋咨询师。</p>
            <p>海豚婚恋成长研究所 版权所有，禁止未经授权转载、修改或商用。</p>
        </footer>
    </div>

    <!-- 确认提交模态框 -->
    <div class="confirmation-modal" id="confirmationModal">
        <div class="modal-content">
            <h3>确认提交测试</h3>
            <p>您确定要提交测试并查看结果吗？提交后将无法修改答案。</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-confirm" id="confirmSubmit">确认提交</button>
                <button class="modal-btn modal-cancel" id="cancelSubmit">再检查一下</button>
            </div>
        </div>
    </div>

    <script>
        // 初始化jsPDF
        window.jsPDF = window.jspdf.jsPDF;

        // 立即执行的初始化代码 - 确保在DOM加载前就设置好全局变量
        (function() {
            // 激活码管理系统 - 每个激活码仅限使用一次
            window.ADMIN_PASSWORD = "hai306952";
            window.activationCodes = JSON.parse(localStorage.getItem('activationCodes')) || {};
            window.adminClickCount = 0;
            window.adminClickTimer = null;
            window.radarChart = null;
            window.barChart = null;
            
            // 全局管理员唤醒函数
            window.showAdminAccess = function() {
                const password = prompt('请输入管理员密码:');
                if (password === window.ADMIN_PASSWORD) {
                    document.getElementById('activationSection').style.display = 'none';
                    document.getElementById('adminSection').style.display = 'block';
                    
                    // 更新当前时间
                    document.getElementById('currentTime').textContent = new Date().toLocaleString();
                    
                    // 显示现有激活码
                    const storedCodes = JSON.parse(localStorage.getItem('activationCodes')) || {};
                    displayActivationCodes(storedCodes);
                } else if (password !== null) {
                    alert('管理员密码错误');
                }
            };
            
            // 全局键盘事件处理
            document.addEventListener('keydown', function(event) {
                // 检测是否按下了 Ctrl+Alt+A
                if (event.ctrlKey && event.altKey && event.key === 'a') {
                    event.preventDefault();
                    window.showAdminAccess();
                }
            });
        })();

        // 工具函数
        function getColorHex(color) {
            const colorMap = {
                red: '#ff6b6b',
                pink: '#ff9ff3',
                purple: '#a29bfe',
                blue: '#74b9ff',
                yellow: '#ffeaa7'
            };
            return colorMap[color] || '#ff6b6b';
        }
        
        function createHeartSVG(color) {
            return `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path fill="${color}" d="M50 20c10 0 20 10 30 0 10 10 10 30-10 40-20 10-20-10-20-10s0 20-20 10C10 50 10 30 20 20c10-10 20 0 30 0z"/></svg>`;
        }
        
        function getDimensionDescription(dimensionId) {
            const descriptions = {
                emotion: "双方情感联结的稳固性与忠诚度",
                personality: "双方性格的互补性与相处和谐度",
                lifestyle: "双方生活细节的契合度",
                self: "双方个人特质的匹配度",
                education: "双方认知层面的契合度",
                career: "双方事业发展的协调性",
                finance: "双方经济规划的一致性",
                family: "双方家庭关系的协调性",
                dreams: "双方人生目标的一致性",
                hobbies: "双方兴趣的兼容性"
            };
            
            return descriptions[dimensionId] || "双方相关方面的适配度";
        }
        
        function getQuestionRange(dimensionId) {
            let start = 1;
            
            for (let i = 0; i < dimensions.length; i++) {
                if (dimensions[i].id === dimensionId) {
                    return `${start}-${start + dimensions[i].questions - 1}`;
                }
                start += dimensions[i].questions;
            }
            
            return '';
        }
        
        function getCompletedQuestionsCount() {
            let count = 0;
            dimensions.forEach(dimension => {
                for (let i = 1; i <= dimension.questions; i++) {
                    const questionName = `${dimension.id}-${i}`;
                    const selectedOption = document.querySelector(`input[name="${questionName}"]:checked`);
                    if (selectedOption) {
                        count++;
                    }
                }
            });
            return count;
        }

        // 测试数据 - 维度信息
        const dimensions = [
            {
                name: "感情基础",
                id: "emotion",
                questions: 15,
                passScore: 45,
                questionsText: [
                    "你和对方在一起时，内心会持续感到踏实且安心，无莫名焦虑吗？",
                    "双方能毫无保留地分享彼此的喜怒哀乐、职场压力及内心秘密，无明显隐瞒吗？",
                    "当发生矛盾或争执时，你们会主动换位思考，先倾听对方诉求再表达观点吗？",
                    "你坚信对方是你愿意携手面对生老病死、重大挫折的人生伴侣吗？",
                    "双方会定期安排专属二人的相处时间（如每周1次约会），主动维持感情温度吗？",
                    "面对异性的主动示好或外界诱惑时，你从未动摇过对这段感情的忠诚吗？",
                    "对方的优点会让你持续欣赏，且你能接纳对方的缺点（如丢三落四）并包容，而非试图强行改变吗？",
                    "当你遇到困难或情绪崩溃时，对方会第一时间放下琐事，给予支持和陪伴吗？",
                    "你们在感情中都愿意为对方做出合理让步（如调整作息），而非固执己见吗？",
                    "你会主动向亲友认可对方的伴侣身份，介绍时以'我的爱人''未来伴侣'相称吗？",
                    "双方对这段感情的未来规划方向一致，都有明确的结婚时间节点或计划吗？",
                    "即使相处超过1年，你依然会被对方的某些特质吸引，无'审美疲劳'感吗？",
                    "在感情中，你从未有过'将就''凑活'的想法，而是发自内心喜爱并认可对方吗？",
                    "当对方生病或遭遇挫折时，你会主动照顾并提供实际帮助，而非仅口头关心吗？",
                    "你们对彼此的爱意表达频率（如每天说'我爱你'）和方式（如拥抱、礼物）感到满意吗？"
                ]
            },
            {
                name: "性格匹配",
                id: "personality",
                questions: 10,
                passScore: 30,
                questionsText: [
                    "你们的情绪稳定性相近（如双方都平和或都外向），不会因一方情绪波动过大而频繁冲突吗？",
                    "你们对'社交频率'的需求一致（如都喜欢宅家或都喜欢外出社交）吗？",
                    "你们的生活节奏（如作息时间、做事快慢）相近，不会因此产生明显矛盾吗？",
                    "面对压力时，你们的应对方式（如倾诉、独处）能互相理解和支持，而非互相指责吗？",
                    "你们的幽默感和笑点相似，能经常因同一事物开怀大笑吗？",
                    "你们的性格具有互补性（如一方细心、一方粗心），能互相弥补而非互相排斥吗？",
                    "你们对'仪式感'的重视程度一致（如都重视生日、纪念日或都觉得无所谓）吗？",
                    "你们处理冲突的方式相似（如都喜欢当场解决或都需要冷静后再沟通）吗？",
                    "你们的控制欲强度相当，不会因一方过度掌控或过度放任而产生不适吗？",
                    "你们的表达直接程度相近（如都坦率直接或都含蓄内敛），能准确理解对方的言外之意吗？"
                ]
            },
            {
                name: "生活习惯",
                id: "lifestyle",
                questions: 10,
                passScore: 30,
                questionsText: [
                    "你们的饮食习惯（如口味咸淡、是否吃辣、三餐时间）相近或能互相适应吗？",
                    "你们对家居整洁度的要求一致（如都喜欢整洁或都能接受适度凌乱）吗？",
                    "你们的作息时间（如早睡早起或晚睡晚起）相近，不会互相干扰吗？",
                    "你们对吸烟、饮酒、熬夜等生活习惯的接受度一致吗？",
                    "你们的消费习惯（如理性消费或感性消费）相似，不会因花钱方式频繁争执吗？",
                    "你们对家务分工的观念一致（如共同承担或按能力分工）吗？",
                    "你们的运动习惯（如是否坚持运动、喜欢的运动类型）相近或能互相支持吗？",
                    "你们对'私人空间'的需求程度一致（如需要独处时间的多少）吗？",
                    "你们对节假日安排的偏好（如外出旅行或居家休息）相似吗？",
                    "你们对宠物的态度（如是否养宠物、喜欢什么宠物）一致吗？"
                ]
            },
            {
                name: "自我认知",
                id: "self",
                questions: 10,
                passScore: 30,
                questionsText: [
                    "你们都清楚自己在感情中的需求和底线，并已向对方明确表达吗？",
                    "你们都能接纳自己的不完美，并不过度要求对方完美吗？",
                    "你们都有独立的社交圈和个人爱好，不会过度依赖对方吗？",
                    "你们都能正视自己的错误并主动道歉，而非固执己见吗？",
                    "你们都了解自己的情绪触发点，并能主动避免在对方面前过度爆发吗？",
                    "你们都有清晰的个人边界，并尊重对方的边界吗？",
                    "你们都有独立处理问题的能力，不会事事依赖对方解决吗？",
                    "你们都清楚自己在婚姻中的角色期待（如丈夫/妻子应承担的责任），且双方期待一致吗？",
                    "你们都能进行自我反思，并在关系中持续成长吗？",
                    "你们都能在保持自我的同时，为关系做出适当调整和妥协吗？"
                ]
            },
            {
                name: "认知观念",
                id: "education",
                questions: 10,
                passScore: 30,
                questionsText: [
                    "你们对婚姻的理解和期待（如婚姻的意义、夫妻的责任）基本一致吗？",
                    "你们对性别角色的认知（如男主外女主内或共同承担）相似吗？",
                    "你们对子女教育的理念（如严厉教育或快乐成长）基本一致吗？",
                    "你们对孝顺父母的方式和程度期待一致吗？",
                    "你们对社会热点问题的看法虽不必完全相同，但能互相尊重理解吗？",
                    "你们对文化、艺术、娱乐的兴趣和理解程度相近，有共同话题吗？",
                    "你们对金钱的意义和价值的看法（如储蓄重要还是享受当下）基本一致吗？",
                    "你们对工作与生活平衡的理解相似吗？",
                    "你们对健康和养生的重视程度相近吗？",
                    "你们对宗教信仰或精神追求的态度（如有信仰或无信仰）互相尊重吗？"
                ]
            },
            {
                name: "事业规划",
                id: "career",
                questions: 10,
                passScore: 30,
                questionsText: [
                    "你们对各自的职业发展方向和目标互相支持，而非互相阻碍吗？",
                    "你们对工作压力和加班的接受程度相近，能互相理解吗？",
                    "你们对未来3-5年的职业规划有共识，并能互相配合吗？",
                    "你们对工作与家庭的优先级排序基本一致吗？",
                    "你们对创业或稳定工作的偏好一致，或能支持对方的选择吗？",
                    "你们对异地工作或出差的接受程度有共识吗？",
                    "你们对职业培训和继续教育的态度（如是否愿意持续学习）相似吗？",
                    "你们对退休年龄和退休后的生活规划有大致共识吗？",
                    "你们能在职业发展上互相提供建议和支持吗？",
                    "你们对女性婚后是否继续工作的看法一致吗？"
                ]
            },
            {
                name: "经济观念",
                id: "finance",
                questions: 10,
                passScore: 30,
                questionsText: [
                    "你们对婚前财产公证的态度一致吗？",
                    "你们对婚后财务支配方式（如AA制、共同账户或一方管理）有共识吗？",
                    "你们对每月储蓄比例和理财方式的看法基本一致吗？",
                    "你们对大额消费（如买房、买车）的决策方式有共识吗？",
                    "你们对奢侈品和非必需品的消费观念相似吗？",
                    "你们对借钱给亲友的态度和原则一致吗？",
                    "你们对未来房贷、车贷等负债的接受程度相近吗？",
                    "你们对双方父母的经济支持力度有共识吗？",
                    "你们对保险的重视程度和购买意愿一致吗？",
                    "你们对'足够的经济基础'的定义（如存款数额、收入水平）相近吗？"
                ]
            },
            {
                name: "家庭关系",
                id: "family",
                questions: 10,
                passScore: 30,
                questionsText: [
                    "你们对婚后是否与父母同住的想法一致吗？",
                    "你们的父母对这段关系持支持态度吗？",
                    "你们对探望双方父母的频率和方式有共识吗？",
                    "你们对处理婆媳/翁婿关系的原则有共识吗？",
                    "你们对亲戚间的往来疏密程度期待一致吗？",
                    "你们对生育子女的数量和时间规划有共识吗？",
                    "你们对谁来主要照顾孩子的问题有共识吗？",
                    "你们对子女教育中父母角色分工的想法一致吗？",
                    "你们对家庭重大决策（如买房、投资）的参与方式（如仅夫妻决定或咨询父母）有共识吗？",
                    "你们对家庭节日（如春节）在谁家过的安排有共识吗？"
                ]
            },
            {
                name: "人生目标",
                id: "dreams",
                questions: 10,
                passScore: 30,
                questionsText: [
                    "你们对未来居住地（如城市选择）的规划一致吗？",
                    "你们对生活品质的追求（如简单生活或精致生活）程度相近吗？",
                    "你们对是否要孩子以及生育时间的规划一致吗？",
                    "你们对退休后的生活安排（如环游世界或居家养老）有相似憧憬吗？",
                    "你们对家庭与事业的平衡优先级看法一致吗？",
                    "你们对未来5年、10年的生活蓝图有相似构想吗？",
                    "你们对精神生活的追求（如阅读、旅行、艺术）程度相近吗？",
                    "你们对是否移民或长期出国生活的想法一致吗？",
                    "你们对人生成功的定义（如事业有成或家庭幸福）相似吗？",
                    "你们对如何度过晚年的设想（如与子女同住或独立生活）一致吗？"
                ]
            },
            {
                name: "兴趣爱好",
                id: "hobbies",
                questions: 10,
                passScore: 30,
                questionsText: [
                    "你们至少有3项以上共同的兴趣爱好，可以一起参与吗？",
                    "你们虽然有不同爱好，但能尊重并支持对方的选择吗？",
                    "你们喜欢的休闲方式（如运动、看电影、旅行）有重叠吗？",
                    "你们喜欢的音乐、电影或书籍类型有相似之处吗？",
                    "你们对美食的口味偏好和探索欲望相近吗？",
                    "你们对旅行的方式（如自由行或跟团游）和目的地选择有共识吗？",
                    "你们对居家活动（如做饭、游戏、看电视）的喜好程度相近吗？",
                    "你们愿意尝试对方喜欢的活动，并从中找到乐趣吗？",
                    "你们有定期一起参与兴趣活动的习惯吗？",
                    "你们对社交活动的偏好（如热闹聚会或小型聚餐）相似吗？"
                ]
            }
        ];

        // 生成背景爱心元素
        function createBackgroundHearts() {
            const container = document.getElementById('backgroundElements');
            const colors = ['red', 'pink', 'purple', 'blue', 'yellow'];
            const heartCount = 20;
            
            for (let i = 0; i < heartCount; i++) {
                const heart = document.createElement('div');
                heart.className = `balloon heart`;
                
                const color = colors[Math.floor(Math.random() * colors.length)];
                const colorHex = getColorHex(color);
                heart.style.backgroundImage = `url(${createHeartSVG(colorHex)})`;
                
                // 随机位置和大小
                heart.style.left = `${Math.random() * 100}%`;
                heart.style.top = `${Math.random() * 100}%`;
                heart.style.transform = `scale(${0.5 + Math.random() * 0.8})`;
                heart.style.animationDelay = `${Math.random() * 5}s`;
                heart.style.animationDuration = `${10 + Math.random() * 20}s`;
                
                container.appendChild(heart);
            }
        }

        // 生成测试题目
        function generateQuestions() {
            const form = document.getElementById('compatibilityTest');
            let questionNumber = 1;
            
            dimensions.forEach(dimension => {
                const dimensionDiv = document.createElement('div');
                dimensionDiv.className = 'dimension';
                dimensionDiv.id = `dimension-${dimension.id}`;
                
                const dimensionHeader = document.createElement('h2');
                dimensionHeader.textContent = `${dimension.name}（${getQuestionRange(dimension.id)}题）`;
                dimensionDiv.appendChild(dimensionHeader);
                
                const dimensionDesc = document.createElement('p');
                dimensionDesc.textContent = getDimensionDescription(dimension.id);
                dimensionDesc.style.marginBottom = '15px';
                dimensionDesc.style.fontStyle = 'italic';
                dimensionDiv.appendChild(dimensionDesc);
                
                const progressInfo = document.createElement('div');
                progressInfo.className = 'progress-info';
                progressInfo.innerHTML = `本维度共${dimension.questions}题，每题5分，满分${dimension.questions * 5}分，建议得分不低于${dimension.passScore}分`;
                dimensionDiv.appendChild(progressInfo);
                
                dimension.questionsText.forEach((questionText, index) => {
                    const isReverse = questionText.includes('（反）');
                    const cleanedQuestionText = questionText.replace('（反）', '');
                    
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question unanswered';
                    questionDiv.id = `question-${dimension.id}-${index + 1}`;
                    
                    const questionLabel = document.createElement('p');
                    questionLabel.innerHTML = `<strong>${questionNumber}.</strong> ${cleanedQuestionText}${isReverse ? ' <span style="color: #dc3545;">(反向计分)</span>' : ''}`;
                    questionDiv.appendChild(questionLabel);
                    
                    const unansweredMarker = document.createElement('div');
                    unansweredMarker.className = 'unanswered-marker';
                    unansweredMarker.textContent = '未答';
                    questionDiv.appendChild(unansweredMarker);
                    
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'options';
                    
                    const options = ['是', '基本是', '不确定', '基本否', '否'];
                    options.forEach(option => {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'option';
                        
                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.name = `${dimension.id}-${index + 1}`;
                        input.value = option;
                        input.dataset.reverse = isReverse ? 'true' : 'false';
                        
                        input.addEventListener('change', function() {
                            updateQuestionStatus(questionDiv, true);
                            updateSubmitButtonStatus();
                            updateQuestionNavigation();
                        });
                        
                        const label = document.createElement('label');
                        label.textContent = option;
                        
                        optionDiv.appendChild(input);
                        optionDiv.appendChild(label);
                        optionsDiv.appendChild(optionDiv);
                    });
                    
                    questionDiv.appendChild(optionsDiv);
                    dimensionDiv.appendChild(questionDiv);
                    
                    questionNumber++;
                });
                
                form.appendChild(dimensionDiv);
            });
        }

        // 更新问题状态（已答/未答）
        function updateQuestionStatus(questionElement, isAnswered) {
            if (isAnswered) {
                questionElement.classList.remove('unanswered');
                const marker = questionElement.querySelector('.unanswered-marker');
                if (marker) marker.style.display = 'none';
            } else {
                questionElement.classList.add('unanswered');
                const marker = questionElement.querySelector('.unanswered-marker');
                if (marker) marker.style.display = 'block';
            }
        }

        // 更新提交按钮状态
        function updateSubmitButtonStatus() {
            const totalQuestions = dimensions.reduce((total, dim) => total + dim.questions, 0);
            const answeredQuestions = getCompletedQuestionsCount();
            const submitButton = document.getElementById('calculateResults');
            
            if (answeredQuestions === totalQuestions) {
                submitButton.disabled = false;
                document.getElementById('warningMessage').style.display = 'none';
            } else {
                submitButton.disabled = true;
            }
        }

        // 生成问题导航
        function generateQuestionNavigation() {
            const navContainer = document.getElementById('questionNavigation');
            navContainer.innerHTML = '';
            
            dimensions.forEach(dimension => {
                const navDimension = document.createElement('div');
                navDimension.className = 'nav-dimension';
                
                const dimensionTitle = document.createElement('div');
                dimensionTitle.className = 'nav-dimension-title';
                dimensionTitle.textContent = dimension.name;
                dimensionTitle.addEventListener('click', () => {
                    document.getElementById(`dimension-${dimension.id}`).scrollIntoView({
                        behavior: 'smooth'
                    });
                });
                navDimension.appendChild(dimensionTitle);
                
                const questionsContainer = document.createElement('div');
                questionsContainer.className = 'nav-questions';
                
                for (let i = 1; i <= dimension.questions; i++) {
                    const questionNav = document.createElement('div');
                    questionNav.className = 'nav-question';
                    questionNav.textContent = i;
                    questionNav.dataset.dimension = dimension.id;
                    questionNav.dataset.number = i;
                    
                    questionNav.addEventListener('click', () => {
                        document.getElementById(`question-${dimension.id}-${i}`).scrollIntoView({
                            behavior: 'smooth'
                        });
                        
                        // 高亮当前问题
                        document.querySelectorAll('.nav-question').forEach(el => {
                            el.classList.remove('current');
                        });
                        questionNav.classList.add('current');
                    });
                    
                    questionsContainer.appendChild(questionNav);
                }
                
                navDimension.appendChild(questionsContainer);
                navContainer.appendChild(navDimension);
            });
            
            updateQuestionNavigation();
        }

        // 更新问题导航状态
        function updateQuestionNavigation() {
            dimensions.forEach(dimension => {
                for (let i = 1; i <= dimension.questions; i++) {
                    const questionName = `${dimension.id}-${i}`;
                    const isAnswered = document.querySelector(`input[name="${questionName}"]:checked`) !== null;
                    
                    const navItem = document.querySelector(`.nav-question[data-dimension="${dimension.id}"][data-number="${i}"]`);
                    if (navItem) {
                        if (isAnswered) {
                            navItem.classList.add('answered');
                        } else {
                            navItem.classList.remove('answered');
                        }
                    }
                }
            });
        }

        // 计算测试结果
        function calculateResults() {
            const results = {};
            let totalScore = 0;
            
            dimensions.forEach(dimension => {
                let dimensionScore = 0;
                const totalDimensionPoints = dimension.questions * 5;
                
                for (let i = 1; i <= dimension.questions; i++) {
                    const questionName = `${dimension.id}-${i}`;
                    const selectedOption = document.querySelector(`input[name="${questionName}"]:checked`);
                    const isReverse = selectedOption && selectedOption.dataset.reverse === 'true';
                    
                    if (selectedOption) {
                        let points = 0;
                        switch (selectedOption.value) {
                            case '是': points = isReverse ? 1 : 5; break;
                            case '基本是': points = isReverse ? 2 : 4; break;
                            case '不确定': points = 3; break;
                            case '基本否': points = isReverse ? 4 : 2; break;
                            case '否': points = isReverse ? 5 : 1; break;
                        }
                        dimensionScore += points;
                    }
                }
                
                results[dimension.id] = {
                    name: dimension.name,
                    score: dimensionScore,
                    maxScore: totalDimensionPoints,
                    passScore: dimension.passScore,
                    percentage: Math.round((dimensionScore / totalDimensionPoints) * 100)
                };
                
                totalScore += dimensionScore;
            });
            
            return {
                dimensions: results,
                totalScore: totalScore,
                maxTotalScore: dimensions.reduce((total, dim) => total + dim.questions * 5, 0)
            };
        }

        // 显示测试结果
        function displayResults(results) {
            // 显示结果区域
            document.getElementById('resultsSection').style.display = 'block';
            
            // 滚动到结果区域
            document.getElementById('resultsSection').scrollIntoView({
                behavior: 'smooth'
            });
            
            // 更新总分
            document.getElementById('totalScoreCell').innerHTML = `<strong>${results.totalScore}</strong> 分 / ${results.maxTotalScore} 分`;
            
            // 清空表格
            const tableBody = document.getElementById('resultsTableBody');
            tableBody.innerHTML = '';
            
            // 填充表格数据
            Object.values(results.dimensions).forEach(dimension => {
                const row = document.createElement('tr');
                
                // 维度名称
                const nameCell = document.createElement('td');
                nameCell.textContent = dimension.name;
                row.appendChild(nameCell);
                
                // 题目编号
                const rangeCell = document.createElement('td');
                rangeCell.textContent = getQuestionRange(dimension.id);
                row.appendChild(rangeCell);
                
                // 维度得分
                const scoreCell = document.createElement('td');
                scoreCell.textContent = `${dimension.score} 分`;
                row.appendChild(scoreCell);
                
                // 满分
                const maxScoreCell = document.createElement('td');
                maxScoreCell.textContent = `${dimension.maxScore} 分`;
                row.appendChild(maxScoreCell);
                
                // 评价等级
                const ratingCell = document.createElement('td');
                let ratingClass, ratingText;
                
                if (dimension.percentage >= 90) {
                    ratingClass = 'rating-excellent';
                    ratingText = '闭眼冲';
                } else if (dimension.percentage >= 80) {
                    ratingClass = 'rating-good';
                    ratingText = '优秀';
                } else if (dimension.percentage >= 70) {
                    ratingClass = 'rating-medium';
                    ratingText = '达标';
                } else if (dimension.percentage >= 60) {
                    ratingClass = 'rating-poor';
                    ratingText = '待提升';
                } else {
                    ratingClass = 'rating-critical';
                    ratingText = '慎重';
                }
                
                ratingCell.innerHTML = `<span class="${ratingClass}">${ratingText} (${dimension.percentage}%)</span>`;
                row.appendChild(ratingCell);
                
                tableBody.appendChild(row);
            });
            
            // 生成评语
            generateCommentary(results);
            
            // 生成个性化建议
            generatePersonalizedAdvice(results);
            
            // 创建图表
            createCharts(results);
        }

        // 生成评语
        function generateCommentary(results) {
            const commentaryElement = document.getElementById('commentary');
            const totalPercentage = Math.round((results.totalScore / results.maxTotalScore) * 100);
            
            let mainCommentary = '';
            
            if (totalPercentage >= 90) {
                mainCommentary = `<h3>恭喜！你们的结婚适配度极高（${totalPercentage}%）</h3>
                <p>你们在各个维度的表现都非常出色，情感基础稳固，性格、生活习惯、价值观高度契合。这表明你们已经具备了建立幸福婚姻的坚实基础，是非常理想的伴侣组合。</p>
                <p>你们对彼此有深刻的理解和接纳，在面对生活挑战时能够同心协力。这样的关系质量令人羡慕，建议可以积极推进婚姻计划。</p>`;
            } else if (totalPercentage >= 80) {
                mainCommentary = `<h3>优秀！你们的结婚适配度良好（${totalPercentage}%）</h3>
                <p>你们的关系整体状况优秀，在大多数关键维度上都表现良好。彼此的契合度较高，具备建立稳定婚姻的条件。</p>
                <p>虽然在某些方面可能存在小的差异，但这并不影响整体关系质量。只要继续保持良好的沟通和互相理解，婚姻生活会很幸福。</p>`;
            } else if (totalPercentage >= 70) {
                mainCommentary = `<h3>不错！你们的结婚适配度达标（${totalPercentage}%）</h3>
                <p>你们的关系基本达到婚姻所需的适配度，但存在一些需要关注的方面。总体而言，你们有较好的基础，但需要在某些领域加强沟通和理解。</p>
                <p>建议在婚前针对得分较低的维度进行深入交流，达成更多共识，为婚姻生活做好更充分的准备。</p>`;
            } else if (totalPercentage >= 60) {
                mainCommentary = `<h3>注意：你们的结婚适配度有待提升（${totalPercentage}%）</h3>
                <p>你们的关系在多个关键维度上存在明显差异，需要认真对待。这些差异如果得不到妥善处理，可能会成为婚姻中的隐患。</p>
                <p>建议推迟结婚计划，先针对得分较低的维度进行深入沟通和调整，必要时可以寻求专业婚恋咨询的帮助，看看是否能够达成更多共识。</p>`;
            } else {
                mainCommentary = `<h3>慎重：你们的结婚适配度较低（${totalPercentage}%）</h3>
                <p>你们在多个核心维度上存在较大分歧，目前的状态可能不太适合进入婚姻。这些深层次的差异可能会在婚姻中引发持续的冲突。</p>
                <p>建议认真思考你们是否真的适合彼此，是否有信心和能力解决这些根本性的分歧。在做出结婚决定前，强烈建议进行专业的婚恋咨询。</p>`;
            }
            
            // 找出最高分和最低分的维度
            const dimensionScores = Object.values(results.dimensions);
            const bestDimension = dimensionScores.reduce((best, current) => 
                current.percentage > best.percentage ? current : best, dimensionScores[0]);
            const worstDimension = dimensionScores.reduce((worst, current) => 
                current.percentage < worst.percentage ? current : worst, dimensionScores[0]);
            
            const additionalCommentary = `<p><strong>你们的优势领域：</strong>${bestDimension.name}（${bestDimension.percentage}%）- 这是你们关系中最稳固的部分，继续保持。</p>
            <p><strong>需要关注的领域：</strong>${worstDimension.name}（${worstDimension.percentage}%）- 这是你们关系中最薄弱的环节，建议重点改善。</p>`;
            
            commentaryElement.innerHTML = mainCommentary + additionalCommentary;
        }

        // 生成个性化建议
        function generatePersonalizedAdvice(results) {
            const adviceElement = document.getElementById('personalizedAdvice');
            
            // 找出得分最低的三个维度
            const dimensionScores = Object.values(results.dimensions);
            const sortedDimensions = [...dimensionScores].sort((a, b) => a.percentage - b.percentage);
            const lowestDimensions = sortedDimensions.slice(0, 3);
            
            // 针对不同维度的建议
            const adviceMap = {
                emotion: "1. 增加每日高质量沟通时间，分享彼此的感受和想法\n2. 定期安排浪漫约会，重温初识时的美好\n3. 学习更有效的冲突解决技巧，避免指责和冷战\n4. 共同创造专属你们的仪式感和传统",
                personality: "1. 深入了解并接纳对方的性格特质，而非试图改变\n2. 学习利用性格互补性，而非让差异成为冲突点\n3. 理解对方表达爱意的方式可能与你不同\n4. 共同制定处理情绪和压力的策略",
                lifestyle: "1. 找出生活习惯中的冲突点，制定双方都能接受的妥协方案\n2. 共同参与家务，建立公平的分工模式\n3. 尊重对方的生活节奏，寻找平衡点\n4. 一起培养新的健康生活习惯",
                self: "1. 增强自我认知，明确自己在关系中的需求和边界\n2. 保持适当的独立性，同时培养共同成长的意识\n3. 学习自我调节情绪，避免过度依赖对方\n4. 接受自己和对方的不完美，减少评判",
                education: "1. 增加深度交流的机会，了解彼此的核心价值观\n2. 尊重观念差异，寻找共同点和折中方案\n3. 共同学习新事物，拓展认知边界\n4. 讨论并明确对婚姻、家庭的核心期待",
                career: "1. 深入交流职业规划和目标，寻找互相支持的方式\n2. 建立健康的工作-生活平衡观念\n3. 讨论并规划家庭与事业的优先级\n4. 支持对方的职业发展，共同庆祝职业成就",
                finance: "1. 坦诚交流对金钱的看法和习惯\n2. 制定共同的财务目标和预算计划\n3. 明确财务决策的方式和责任分工\n4. 学习理财知识，共同管理家庭财务",
                family: "1. 与双方家庭建立健康的边界\n2. 共同制定处理家庭关系的原则和策略\n3. 深入讨论对子女教育和养育的看法\n4. 提前规划如何平衡小家庭与原生家庭的关系",
                dreams: "1. 分享并倾听彼此的人生愿景和梦想\n2. 寻找个人目标与共同目标的结合点\n3. 制定短期和长期的共同计划\n4. 定期回顾和调整你们的人生规划",
                hobbies: "1. 尝试参与并了解对方的兴趣爱好\n2. 每周安排一次共同参与的活动\n3. 尊重并支持对方的个人兴趣\n4. 一起探索和培养新的共同爱好"
            };
            
            let adviceHTML = `<h4>针对你们关系的个性化建议</h4><ul>`;
            
            lowestDimensions.forEach(dimension => {
                const dimensionId = Object.keys(results.dimensions).find(key => results.dimensions[key].name === dimension.name);
                const advice = adviceMap[dimensionId] || "1. 增加沟通，深入了解彼此的想法和需求\n2. 寻找共同的解决方案，而非坚持己见\n3. 定期回顾关系进展，及时调整";
                
                adviceHTML += `<li><strong>${dimension.name}：</strong>
                    <ul style="margin-top: 5px;">
                        ${advice.split('\n').map(point => `<li>${point}</li>`).join('')}
                    </ul>
                </li>`;
            });
            
            adviceHTML += `</ul><p style="margin-top: 15px;"><strong>通用建议：</strong>无论得分如何，婚姻的成功都需要双方持续的努力和投入。定期沟通、互相尊重、共同成长是维持幸福婚姻的关键。建议每3-6个月重新评估一次你们的关系状况，及时解决出现的问题。</p>`;
            
            adviceElement.innerHTML = adviceHTML;
        }

        // 创建图表
        function createCharts(results) {
            const dimensionData = Object.values(results.dimensions);
            const labels = dimensionData.map(d => d.name);
            const scores = dimensionData.map(d => d.percentage);
            const backgroundColors = [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)',
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)'
            ];
            const borderColors = [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)'
            ];
            
            // 销毁现有图表（如果存在）
            if (window.radarChart) {
                window.radarChart.destroy();
            }
            if (window.barChart) {
                window.barChart.destroy();
            }
            
            // 创建雷达图
            const radarCtx = document.getElementById('radarChart').getContext('2d');
            window.radarChart = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '适配度百分比',
                        data: scores,
                        backgroundColor: 'rgba(255, 107, 157, 0.2)',
                        borderColor: 'rgba(255, 107, 157, 1)',
                        pointBackgroundColor: 'rgba(255, 107, 157, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(255, 107, 157, 1)'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    }
                }
            });
            
            // 创建柱状图
            const barCtx = document.getElementById('barChart').getContext('2d');
            window.barChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '适配度百分比',
                        data: scores,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: '适配度百分比'
                            }
                        }
                    }
                }
            });
        }

        // 导出为图片
        function exportAsImage() {
            const resultsSection = document.getElementById('resultsSection');
            
            html2canvas(resultsSection).then(canvas => {
                const link = document.createElement('a');
                link.download = '结婚适配度测试结果.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        // 导出为PDF
        function exportAsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const resultsSection = document.getElementById('resultsSection');
            
            html2canvas(resultsSection).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4宽度(mm)
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                doc.save('结婚适配度测试结果.pdf');
            });
        }

        // 保存答题进度
        function saveProgress() {
            const answers = {};
            
            // 保存普通题答案
            dimensions.forEach(dimension => {
                for (let i = 1; i <= dimension.questions; i++) {
                    const questionName = `${dimension.id}-${i}`;
                    const selectedOption = document.querySelector(`input[name="${questionName}"]:checked`);
                    if (selectedOption) {
                        answers[questionName] = selectedOption.value;
                    }
                }
            });
            
            // 保存特殊题答案
            for (let i = 1; i <= 3; i++) {
                const questionName = `special${i}`;
                const selectedOption = document.querySelector(`input[name="${questionName}"]:checked`);
                if (selectedOption) {
                    answers[questionName] = selectedOption.value;
                }
            }
            
            localStorage.setItem('testProgress', JSON.stringify(answers));
            alert('答题进度已保存！');
        }

        // 加载答题进度
        function loadProgress() {
            const savedAnswers = JSON.parse(localStorage.getItem('testProgress'));
            
            if (!savedAnswers || Object.keys(savedAnswers).length === 0) {
                alert('没有找到保存的答题进度！');
                return;
            }
            
            // 加载普通题答案
            Object.keys(savedAnswers).forEach(questionName => {
                if (questionName.startsWith('special')) return;
                
                const inputElement = document.querySelector(`input[name="${questionName}"][value="${savedAnswers[questionName]}"]`);
                if (inputElement) {
                    inputElement.checked = true;
                    
                    // 更新问题状态
                    const [dimensionId, questionNum] = questionName.split('-');
                    const questionElement = document.getElementById(`question-${dimensionId}-${questionNum}`);
                    if (questionElement) {
                        updateQuestionStatus(questionElement, true);
                    }
                }
            });
            
            // 加载特殊题答案
            for (let i = 1; i <= 3; i++) {
                const questionName = `special${i}`;
                if (savedAnswers[questionName]) {
                    const inputElement = document.querySelector(`input[name="${questionName}"][value="${savedAnswers[questionName]}"]`);
                    if (inputElement) {
                        inputElement.checked = true;
                    }
                }
            }
            
            updateSubmitButtonStatus();
            updateQuestionNavigation();
            alert('答题进度已加载！');
        }

        // 清除答题进度
        function clearProgress() {
            if (confirm('确定要清除所有答题进度吗？此操作不可恢复。')) {
                localStorage.removeItem('testProgress');
                
                // 清除所有选中状态
                document.querySelectorAll('input[type="radio"]:checked').forEach(input => {
                    input.checked = false;
                });
                
                // 更新问题状态
                document.querySelectorAll('.question').forEach(question => {
                    updateQuestionStatus(question, false);
                });
                
                updateSubmitButtonStatus();
                updateQuestionNavigation();
                alert('答题进度已清除！');
            }
        }

        // 生成激活码
        function generateActivationCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // 生成多个激活码
        function generateMultipleCodes(count = 20, daysToExpire = 30) {
            const newCodes = {};
            const today = new Date();
            
            for (let i = 0; i < count; i++) {
                const code = generateActivationCode();
                // 计算过期日期
                const expireDate = new Date();
                expireDate.setDate(today.getDate() + daysToExpire);
                
                newCodes[code] = {
                    generated: today.toISOString(),
                    expires: expireDate.toISOString(),
                    used: false,
                    usedDate: null
                };
            }
            
            // 保存到localStorage
            const existingCodes = JSON.parse(localStorage.getItem('activationCodes')) || {};
            const updatedCodes = { ...existingCodes, ...newCodes };
            localStorage.setItem('activationCodes', JSON.stringify(updatedCodes));
            
            return newCodes;
        }

        // 显示激活码列表
        function displayActivationCodes(codes) {
            const container = document.getElementById('activationCodesList');
            container.innerHTML = '';
            
            if (Object.keys(codes).length === 0) {
                container.innerHTML = '<p>暂无激活码</p>';
                return;
            }
            
            // 按生成日期排序（最新的在前）
            const sortedCodes = Object.entries(codes).sort((a, b) => 
                new Date(b[1].generated) - new Date(a[1].generated)
            );
            
            const today = new Date();
            
            sortedCodes.forEach(([code, info]) => {
                const codeElement = document.createElement('div');
                codeElement.style.marginBottom = '8px';
                codeElement.style.padding = '5px';
                codeElement.style.borderRadius = '4px';
                
                // 判断是否过期
                const isExpired = new Date(info.expires) < today;
                // 判断是否已使用
                const isUsed = info.used;
                
                // 设置样式
                if (isExpired) {
                    codeElement.style.backgroundColor = '#ffebee';
                    codeElement.style.textDecoration = 'line-through';
                } else if (isUsed) {
                    codeElement.style.backgroundColor = '#e8f5e9';
                } else {
                    codeElement.style.backgroundColor = '#e3f2fd';
                }
                
                // 格式化日期
                const formatDate = (dateString) => {
                    if (!dateString) return '未使用';
                    const date = new Date(dateString);
                    return date.toLocaleString();
                };
                
                codeElement.innerHTML = `
                    <strong>${code}</strong> 
                    <span style="font-size: 0.8rem; margin-left: 10px;">
                        生成: ${formatDate(info.generated)}<br>
                        过期: ${formatDate(info.expires)}<br>
                        状态: ${isExpired ? '已过期' : isUsed ? '已使用' : '未使用'}<br>
                        ${isUsed ? `使用时间: ${formatDate(info.usedDate)}` : ''}
                    </span>
                `;
                
                container.appendChild(codeElement);
            });
        }

        // 验证激活码
        function validateActivationCode(code) {
            if (!code) return { valid: false, message: '请输入激活码' };
            
            const codes = JSON.parse(localStorage.getItem('activationCodes')) || {};
            const codeInfo = codes[code];
            
            if (!codeInfo) {
                return { valid: false, message: '无效的激活码' };
            }
            
            const today = new Date();
            if (new Date(codeInfo.expires) < today) {
                return { valid: false, message: '激活码已过期' };
            }
            
            if (codeInfo.used) {
                return { valid: false, message: '激活码已使用' };
            }
            
            // 标记为已使用
            codeInfo.used = true;
            codeInfo.usedDate = new Date().toISOString();
            localStorage.setItem('activationCodes', JSON.stringify(codes));
            
            return { valid: true, message: '激活成功' };
        }

        // 检查激活码使用状态并显示
        function checkActivationCodeStatus() {
            const input = document.getElementById('activationInput');
            const code = input.value.trim();
            const infoElement = document.getElementById('usageInfo');
            
            if (!code) {
                infoElement.textContent = '';
                return;
            }
            
            const codes = JSON.parse(localStorage.getItem('activationCodes')) || {};
            const codeInfo = codes[code];
            
            if (!codeInfo) {
                infoElement.textContent = '该激活码不存在';
                infoElement.style.color = '#dc3545';
            } else {
                const today = new Date();
                if (new Date(codeInfo.expires) < today) {
                    infoElement.textContent = '该激活码已过期';
                    infoElement.style.color = '#dc3545';
                } else if (codeInfo.used) {
                    infoElement.textContent = '该激活码已使用';
                    infoElement.style.color = '#dc3545';
                } else {
                    infoElement.textContent = '该激活码有效，可使用';
                    infoElement.style.color = '#28a745';
                }
            }
        }

        // 初始化事件监听
        function initEventListeners() {
            // 导航切换按钮
            document.getElementById('navToggle').addEventListener('click', function() {
                const navigation = document.getElementById('questionNavigation');
                navigation.style.display = navigation.style.display === 'block' ? 'none' : 'block';
            });
            
            // 提交测试按钮
            document.getElementById('calculateResults').addEventListener('click', function() {
                const totalQuestions = dimensions.reduce((total, dim) => total + dim.questions, 0);
                const answeredQuestions = getCompletedQuestionsCount();
                
                if (answeredQuestions < totalQuestions) {
                    document.getElementById('unansweredCount').textContent = totalQuestions - answeredQuestions;
                    document.getElementById('warningMessage').style.display = 'block';
                    return;
                }
                
                // 显示确认模态框
                document.getElementById('confirmationModal').style.display = 'flex';
            });
            
            // 确认提交
            document.getElementById('confirmSubmit').addEventListener('click', function() {
                document.getElementById('confirmationModal').style.display = 'none';
                const results = calculateResults();
                displayResults(results);
            });
            
            // 取消提交
            document.getElementById('cancelSubmit').addEventListener('click', function() {
                document.getElementById('confirmationModal').style.display = 'none';
            });
            
            // 导出按钮
            document.getElementById('exportImage').addEventListener('click', exportAsImage);
            document.getElementById('exportPDF').addEventListener('click', exportAsPDF);
            
            // 进度管理按钮
            document.getElementById('saveProgressBtn').addEventListener('click', saveProgress);
            document.getElementById('loadProgressBtn').addEventListener('click', loadProgress);
            document.getElementById('clearProgressBtn').addEventListener('click', clearProgress);
            
            // 管理员入口 - 点击次数触发
            const adminTriggers = document.querySelectorAll('.admin-trigger');
            adminTriggers.forEach(trigger => {
                trigger.addEventListener('click', function() {
                    window.adminClickCount++;
                    
                    if (window.adminClickTimer) {
                        clearTimeout(window.adminClickTimer);
                    }
                    
                    window.adminClickTimer = setTimeout(() => {
                        if (window.adminClickCount >= 5) {
                            window.showAdminAccess();
                        }
                        window.adminClickCount = 0;
                    }, 1000);
                });
            });
            
            // 隐藏的管理员按钮
            document.getElementById('hiddenAdminBtn').addEventListener('click', window.showAdminAccess);
            
            // 管理员按钮
            document.getElementById('generateCodesBtn').addEventListener('click', function() {
                generateMultipleCodes();
                const storedCodes = JSON.parse(localStorage.getItem('activationCodes')) || {};
                displayActivationCodes(storedCodes);
                alert('已生成20个新的激活码，有效期30天');
            });
            
            document.getElementById('clearStorageBtn').addEventListener('click', function() {
                if (confirm('确定要清除所有数据吗？包括激活码和测试记录。此操作不可恢复。')) {
                    localStorage.clear();
                    window.activationCodes = {};
                    displayActivationCodes({});
                    alert('所有数据已清除');
                }
            });
            
            document.getElementById('backToActivationBtn').addEventListener('click', function() {
                document.getElementById('adminSection').style.display = 'none';
                document.getElementById('activationSection').style.display = 'block';
            });
            
            // 激活按钮
            document.getElementById('activateBtn').addEventListener('click', function() {
                const code = document.getElementById('activationInput').value.trim();
                const result = validateActivationCode(code);
                
                if (result.valid) {
                    alert(result.message);
                    document.getElementById('activationSection').style.display = 'none';
                    document.getElementById('testContainer').style.display = 'block';
                } else {
                    alert(result.message);
                }
            });
            
            // 激活码输入框事件
            document.getElementById('activationInput').addEventListener('input', checkActivationCodeStatus);
            document.getElementById('activationInput').addEventListener('blur', checkActivationCodeStatus);
            
            // 回车激活
            document.getElementById('activationInput').addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    document.getElementById('activateBtn').click();
                }
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            createBackgroundHearts();
            generateQuestions();
            generateQuestionNavigation();
            initEventListeners();
        });
    </script>
</body>
</html>
